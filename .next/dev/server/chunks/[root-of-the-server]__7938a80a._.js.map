{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/rahmanbazarov/Data/programming/BedRock/src/lib/rate-limit.ts"],"sourcesContent":["const rateLimitMap = new Map<string, { count: number; resetAt: number }>()\n\n// Cleanup stale entries every 5 minutes\nsetInterval(() => {\n  const now = Date.now()\n  for (const [key, entry] of rateLimitMap) {\n    if (now > entry.resetAt) {\n      rateLimitMap.delete(key)\n    }\n  }\n}, 5 * 60_000)\n\nexport function checkRateLimit(\n  key: string,\n  maxRequests: number = 10,\n  windowMs: number = 60_000\n): { allowed: boolean; remaining: number; resetIn: number } {\n  const now = Date.now()\n  const entry = rateLimitMap.get(key)\n\n  if (!entry || now > entry.resetAt) {\n    rateLimitMap.set(key, { count: 1, resetAt: now + windowMs })\n    return { allowed: true, remaining: maxRequests - 1, resetIn: windowMs }\n  }\n\n  if (entry.count >= maxRequests) {\n    return { allowed: false, remaining: 0, resetIn: entry.resetAt - now }\n  }\n\n  entry.count++\n  return { allowed: true, remaining: maxRequests - entry.count, resetIn: entry.resetAt - now }\n}\n\nexport function getClientIp(request: Request): string {\n  const forwarded = request.headers.get('x-forwarded-for')\n  const realIp = request.headers.get('x-real-ip')\n  return forwarded?.split(',')[0]?.trim() || realIp || 'unknown'\n}\n"],"names":[],"mappings":";;;;;;AAAA,MAAM,eAAe,IAAI;AAEzB,wCAAwC;AACxC,YAAY;IACV,MAAM,MAAM,KAAK,GAAG;IACpB,KAAK,MAAM,CAAC,KAAK,MAAM,IAAI,aAAc;QACvC,IAAI,MAAM,MAAM,OAAO,EAAE;YACvB,aAAa,MAAM,CAAC;QACtB;IACF;AACF,GAAG,IAAI;AAEA,SAAS,eACd,GAAW,EACX,cAAsB,EAAE,EACxB,WAAmB,MAAM;IAEzB,MAAM,MAAM,KAAK,GAAG;IACpB,MAAM,QAAQ,aAAa,GAAG,CAAC;IAE/B,IAAI,CAAC,SAAS,MAAM,MAAM,OAAO,EAAE;QACjC,aAAa,GAAG,CAAC,KAAK;YAAE,OAAO;YAAG,SAAS,MAAM;QAAS;QAC1D,OAAO;YAAE,SAAS;YAAM,WAAW,cAAc;YAAG,SAAS;QAAS;IACxE;IAEA,IAAI,MAAM,KAAK,IAAI,aAAa;QAC9B,OAAO;YAAE,SAAS;YAAO,WAAW;YAAG,SAAS,MAAM,OAAO,GAAG;QAAI;IACtE;IAEA,MAAM,KAAK;IACX,OAAO;QAAE,SAAS;QAAM,WAAW,cAAc,MAAM,KAAK;QAAE,SAAS,MAAM,OAAO,GAAG;IAAI;AAC7F;AAEO,SAAS,YAAY,OAAgB;IAC1C,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;IACtC,MAAM,SAAS,QAAQ,OAAO,CAAC,GAAG,CAAC;IACnC,OAAO,WAAW,MAAM,IAAI,CAAC,EAAE,EAAE,UAAU,UAAU;AACvD"}},
    {"offset": {"line": 99, "column": 0}, "map": {"version":3,"sources":["file:///Users/rahmanbazarov/Data/programming/BedRock/src/app/api/verify/document-extract/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport Anthropic from '@anthropic-ai/sdk'\nimport { checkRateLimit, getClientIp } from '@/lib/rate-limit'\n\nfunction getAnthropicClient() {\n  return new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY! })\n}\n\ntype ImageMediaType = 'image/jpeg' | 'image/png' | 'image/gif' | 'image/webp'\n\nconst PROMPTS: Record<string, string> = {\n  passport: `You are analyzing a passport document image. Extract the following information and return ONLY valid JSON with no other text:\n\n{\n  \"fullName\": \"full name as shown on passport or null\",\n  \"firstName\": \"first/given name or null\",\n  \"lastName\": \"surname/family name or null\",\n  \"middleName\": \"middle name if present or null\",\n  \"dateOfBirth\": \"date of birth in YYYY-MM-DD format or null\",\n  \"gender\": \"M, F, or X as shown or null\",\n  \"placeOfBirth\": \"place of birth or null\",\n  \"nationality\": \"nationality or null\",\n  \"passportNumber\": \"passport number or null\",\n  \"expiryDate\": \"expiry date in YYYY-MM-DD format or null\",\n  \"issuingCountry\": \"issuing country or null\"\n}\n\nReturn null for any field you cannot read clearly. Do not guess.`,\n\n  local_id: `You are analyzing a government-issued ID document (driver's license, national ID card, etc.). Extract the following information and return ONLY valid JSON with no other text:\n\n{\n  \"fullName\": \"full name as shown on ID or null\",\n  \"firstName\": \"first/given name or null\",\n  \"lastName\": \"surname/family name or null\",\n  \"dateOfBirth\": \"date of birth in YYYY-MM-DD format or null\",\n  \"idNumber\": \"ID/license number or null\",\n  \"address\": \"full address if shown or null\",\n  \"expiryDate\": \"expiry date in YYYY-MM-DD format or null\",\n  \"issuingAuthority\": \"issuing authority/state or null\"\n}\n\nReturn null for any field you cannot read clearly. Do not guess.`,\n\n  address_proof: `You are analyzing a proof of address document (utility bill, bank statement, official letter, etc.). Extract the following information and return ONLY valid JSON with no other text:\n\n{\n  \"fullName\": \"name of the person/account holder or null\",\n  \"address\": \"full street address as shown or null\",\n  \"city\": \"city or null\",\n  \"state\": \"state/province or null\",\n  \"postalCode\": \"postal/zip code or null\",\n  \"country\": \"country or null\",\n  \"documentDate\": \"date on the document in YYYY-MM-DD format or null\",\n  \"issuingCompany\": \"company/organization that issued the document or null\"\n}\n\nReturn null for any field you cannot read clearly. Do not guess.`,\n}\n\nexport async function POST(request: Request) {\n  try {\n    const ip = getClientIp(request)\n    const { allowed } = checkRateLimit(`verify-doc:${ip}`, 5, 60_000)\n    if (!allowed) {\n      return NextResponse.json(\n        { error: 'Too many requests. Please try again later.' },\n        { status: 429, headers: { 'Retry-After': '60' } }\n      )\n    }\n\n    const formData = await request.formData()\n    const file = formData.get('file') as File | null\n    const documentType = formData.get('documentType') as string | null\n\n    if (!file || !documentType) {\n      return NextResponse.json(\n        { error: 'File and documentType are required' },\n        { status: 400 },\n      )\n    }\n\n    // Validate file size (max 10MB)\n    const MAX_FILE_SIZE = 10 * 1024 * 1024\n    if (file.size > MAX_FILE_SIZE) {\n      return NextResponse.json(\n        { error: 'File too large. Maximum size is 10MB.' },\n        { status: 400 },\n      )\n    }\n\n    if (file.type === 'application/pdf') {\n      return NextResponse.json(\n        { error: 'PDF files are not supported. Please upload an image (JPG, PNG, or WebP).' },\n        { status: 400 },\n      )\n    }\n\n    const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']\n    if (!validTypes.includes(file.type)) {\n      return NextResponse.json(\n        { error: 'Unsupported file type. Please upload a JPG, PNG, or WebP image.' },\n        { status: 400 },\n      )\n    }\n\n    const prompt = PROMPTS[documentType]\n    if (!prompt) {\n      return NextResponse.json(\n        { error: `Invalid document type: ${documentType}` },\n        { status: 400 },\n      )\n    }\n\n    const arrayBuffer = await file.arrayBuffer()\n    const base64 = Buffer.from(arrayBuffer).toString('base64')\n\n    const anthropic = getAnthropicClient()\n\n    const response = await anthropic.messages.create({\n      model: 'claude-sonnet-4-5-20250929',\n      max_tokens: 1024,\n      messages: [\n        {\n          role: 'user',\n          content: [\n            {\n              type: 'image',\n              source: {\n                type: 'base64',\n                media_type: file.type as ImageMediaType,\n                data: base64,\n              },\n            },\n            { type: 'text', text: prompt },\n          ],\n        },\n      ],\n    })\n\n    const textBlock = response.content.find((b) => b.type === 'text')\n    const rawText = textBlock && 'text' in textBlock ? textBlock.text : ''\n\n    const jsonMatch = rawText.match(/\\{[\\s\\S]*\\}/)\n    if (!jsonMatch) {\n      return NextResponse.json(\n        { error: 'Could not extract data from the document. Please try a clearer image.' },\n        { status: 422 },\n      )\n    }\n\n    const extracted = JSON.parse(jsonMatch[0])\n\n    return NextResponse.json({ extracted, documentType })\n  } catch (error) {\n    console.error('Document extraction error:', error)\n    return NextResponse.json(\n      { error: 'Failed to analyze document. Please try again.' },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}