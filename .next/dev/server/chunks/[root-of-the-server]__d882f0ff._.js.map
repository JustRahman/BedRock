{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/rahmanbazarov/Data/programming/BedRock/src/lib/oauth/utils.ts"],"sourcesContent":["import { createHmac, randomBytes } from 'crypto'\nimport { cookies } from 'next/headers'\n\nconst STATE_COOKIE_NAME = 'oauth_state'\nconst STATE_EXPIRY_MS = 15 * 60 * 1000 // 15 minutes\n\nfunction getSecret(): string {\n  const secret = process.env.OAUTH_STATE_SECRET\n  if (!secret) throw new Error('OAUTH_STATE_SECRET is not set')\n  return secret\n}\n\nfunction sign(payload: string): string {\n  return createHmac('sha256', getSecret()).update(payload).digest('hex')\n}\n\nexport function generateStateToken(provider: string, returnStep: number): string {\n  const nonce = randomBytes(16).toString('hex')\n  const timestamp = Date.now().toString()\n  const payload = `${provider}:${returnStep}:${timestamp}:${nonce}`\n  const signature = sign(payload)\n  return `${payload}:${signature}`\n}\n\nexport async function setStateCookie(state: string): Promise<void> {\n  const cookieStore = await cookies()\n  cookieStore.set(STATE_COOKIE_NAME, state, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 900, // 15 minutes\n    path: '/',\n  })\n}\n\nexport async function verifyStateToken(state: string): Promise<{ provider: string; returnStep: number } | null> {\n  const cookieStore = await cookies()\n  const cookieValue = cookieStore.get(STATE_COOKIE_NAME)?.value\n\n  if (!cookieValue || cookieValue !== state) return null\n\n  const parts = state.split(':')\n  if (parts.length !== 5) return null\n\n  const [provider, returnStep, timestamp, nonce, signature] = parts\n  const payload = `${provider}:${returnStep}:${timestamp}:${nonce}`\n  const expectedSignature = sign(payload)\n\n  if (signature !== expectedSignature) return null\n\n  const age = Date.now() - parseInt(timestamp, 10)\n  if (age > STATE_EXPIRY_MS) return null\n\n  // Clear the cookie after verification\n  cookieStore.delete(STATE_COOKIE_NAME)\n\n  return { provider, returnStep: parseInt(returnStep, 10) }\n}\n\n// Simple in-memory cache with TTL for storing OAuth data between callback and retrieval\nconst cache = new Map<string, { data: unknown; expiresAt: number }>()\n\nconst CACHE_TTL_MS = 15 * 60 * 1000 // 15 minutes\n\nexport function cacheSet(key: string, data: unknown): void {\n  cache.set(key, { data, expiresAt: Date.now() + CACHE_TTL_MS })\n}\n\nexport function cacheGet(key: string): unknown | null {\n  const entry = cache.get(key)\n  if (!entry) return null\n  if (Date.now() > entry.expiresAt) {\n    cache.delete(key)\n    return null\n  }\n  return entry.data\n}\n\nexport function cacheDelete(key: string): void {\n  cache.delete(key)\n}\n\nexport function generateSessionId(): string {\n  return randomBytes(32).toString('hex')\n}\n\nexport function getAppUrl(): string {\n  // APP_URL is a runtime env var (read from .env.production by Docker at start)\n  // NEXT_PUBLIC_APP_URL is baked at build time — wrong when building locally\n  return process.env.APP_URL || process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAAA;AACA;;;AAEA,MAAM,oBAAoB;AAC1B,MAAM,kBAAkB,KAAK,KAAK,KAAK,aAAa;;AAEpD,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,kBAAkB;IAC7C,IAAI,CAAC,QAAQ,MAAM,IAAI,MAAM;IAC7B,OAAO;AACT;AAEA,SAAS,KAAK,OAAe;IAC3B,OAAO,IAAA,mHAAU,EAAC,UAAU,aAAa,MAAM,CAAC,SAAS,MAAM,CAAC;AAClE;AAEO,SAAS,mBAAmB,QAAgB,EAAE,UAAkB;IACrE,MAAM,QAAQ,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;IACvC,MAAM,YAAY,KAAK,GAAG,GAAG,QAAQ;IACrC,MAAM,UAAU,GAAG,SAAS,CAAC,EAAE,WAAW,CAAC,EAAE,UAAU,CAAC,EAAE,OAAO;IACjE,MAAM,YAAY,KAAK;IACvB,OAAO,GAAG,QAAQ,CAAC,EAAE,WAAW;AAClC;AAEO,eAAe,eAAe,KAAa;IAChD,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,YAAY,GAAG,CAAC,mBAAmB,OAAO;QACxC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ;QACR,MAAM;IACR;AACF;AAEO,eAAe,iBAAiB,KAAa;IAClD,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,cAAc,YAAY,GAAG,CAAC,oBAAoB;IAExD,IAAI,CAAC,eAAe,gBAAgB,OAAO,OAAO;IAElD,MAAM,QAAQ,MAAM,KAAK,CAAC;IAC1B,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;IAE/B,MAAM,CAAC,UAAU,YAAY,WAAW,OAAO,UAAU,GAAG;IAC5D,MAAM,UAAU,GAAG,SAAS,CAAC,EAAE,WAAW,CAAC,EAAE,UAAU,CAAC,EAAE,OAAO;IACjE,MAAM,oBAAoB,KAAK;IAE/B,IAAI,cAAc,mBAAmB,OAAO;IAE5C,MAAM,MAAM,KAAK,GAAG,KAAK,SAAS,WAAW;IAC7C,IAAI,MAAM,iBAAiB,OAAO;IAElC,sCAAsC;IACtC,YAAY,MAAM,CAAC;IAEnB,OAAO;QAAE;QAAU,YAAY,SAAS,YAAY;IAAI;AAC1D;AAEA,wFAAwF;AACxF,MAAM,QAAQ,IAAI;AAElB,MAAM,eAAe,KAAK,KAAK,KAAK,aAAa;;AAE1C,SAAS,SAAS,GAAW,EAAE,IAAa;IACjD,MAAM,GAAG,CAAC,KAAK;QAAE;QAAM,WAAW,KAAK,GAAG,KAAK;IAAa;AAC9D;AAEO,SAAS,SAAS,GAAW;IAClC,MAAM,QAAQ,MAAM,GAAG,CAAC;IACxB,IAAI,CAAC,OAAO,OAAO;IACnB,IAAI,KAAK,GAAG,KAAK,MAAM,SAAS,EAAE;QAChC,MAAM,MAAM,CAAC;QACb,OAAO;IACT;IACA,OAAO,MAAM,IAAI;AACnB;AAEO,SAAS,YAAY,GAAW;IACrC,MAAM,MAAM,CAAC;AACf;AAEO,SAAS;IACd,OAAO,IAAA,oHAAW,EAAC,IAAI,QAAQ,CAAC;AAClC;AAEO,SAAS;IACd,8EAA8E;IAC9E,2EAA2E;IAC3E,OAAO,QAAQ,GAAG,CAAC,OAAO,iEAAuC;AACnE"}},
    {"offset": {"line": 155, "column": 0}, "map": {"version":3,"sources":["file:///Users/rahmanbazarov/Data/programming/BedRock/src/lib/oauth/github.ts"],"sourcesContent":["import { Octokit } from '@octokit/rest'\nimport { getAppUrl } from './utils'\n\nexport interface GitHubProfileData {\n  login: string\n  name: string | null\n  avatarUrl: string\n  createdAt: string\n  accountAgeYears: number\n  publicRepos: number\n  followers: number\n  totalStars: number\n  topLanguages: string[]\n  commitsLastYear: number\n  commitsLast30Days: number\n}\n\nexport function getGitHubAuthUrl(state: string): string {\n  const clientId = process.env.GITHUB_CLIENT_ID\n  if (!clientId) throw new Error('GITHUB_CLIENT_ID is not set')\n\n  const params = new URLSearchParams({\n    client_id: clientId,\n    scope: 'read:user',\n    state,\n    redirect_uri: `${getAppUrl()}/api/oauth/github/callback`,\n  })\n\n  return `https://github.com/login/oauth/authorize?${params.toString()}`\n}\n\nexport async function exchangeGitHubCode(code: string): Promise<string> {\n  const response = await fetch('https://github.com/login/oauth/access_token', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      Accept: 'application/json',\n    },\n    body: JSON.stringify({\n      client_id: process.env.GITHUB_CLIENT_ID,\n      client_secret: process.env.GITHUB_CLIENT_SECRET,\n      code,\n    }),\n  })\n\n  const data = await response.json()\n  if (data.error) {\n    throw new Error(`GitHub OAuth error: ${data.error_description || data.error}`)\n  }\n\n  return data.access_token\n}\n\nexport async function fetchGitHubProfile(token: string): Promise<GitHubProfileData> {\n  const octokit = new Octokit({ auth: token })\n\n  const { data: user } = await octokit.users.getAuthenticated()\n\n  const { data: repos } = await octokit.repos.listForAuthenticatedUser({\n    sort: 'pushed',\n    per_page: 100,\n  })\n\n  // Aggregate languages\n  const langCounts: Record<string, number> = {}\n  let totalStars = 0\n\n  for (const repo of repos) {\n    if (repo.language) {\n      langCounts[repo.language] = (langCounts[repo.language] || 0) + 1\n    }\n    totalStars += repo.stargazers_count ?? 0\n  }\n\n  const topLanguages = Object.entries(langCounts)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 5)\n    .map(([lang]) => lang)\n\n  const createdAt = user.created_at\n  const accountAgeYears = Math.floor(\n    (Date.now() - new Date(createdAt).getTime()) / (365.25 * 24 * 60 * 60 * 1000)\n  )\n\n  // Fetch commit activity via GraphQL API\n  let commitsLastYear = 0\n  let commitsLast30Days = 0\n  try {\n    const thirtyDaysAgo = new Date()\n    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30)\n\n    const graphqlRes = await fetch('https://api.github.com/graphql', {\n      method: 'POST',\n      headers: {\n        Authorization: `bearer ${token}`,\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        query: `query($since: DateTime!) {\n          viewer {\n            contributionsCollection {\n              totalCommitContributions\n            }\n            recent: contributionsCollection(from: $since) {\n              totalCommitContributions\n            }\n          }\n        }`,\n        variables: { since: thirtyDaysAgo.toISOString() },\n      }),\n    })\n\n    if (graphqlRes.ok) {\n      const gql = await graphqlRes.json()\n      commitsLastYear = gql.data?.viewer?.contributionsCollection?.totalCommitContributions ?? 0\n      commitsLast30Days = gql.data?.viewer?.recent?.totalCommitContributions ?? 0\n    }\n  } catch {\n    // Non-critical — commit data just won't contribute to score\n  }\n\n  return {\n    login: user.login,\n    name: user.name,\n    avatarUrl: user.avatar_url,\n    createdAt,\n    accountAgeYears,\n    publicRepos: user.public_repos,\n    followers: user.followers,\n    totalStars,\n    topLanguages,\n    commitsLastYear,\n    commitsLast30Days,\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 272, "column": 0}, "map": {"version":3,"sources":["file:///Users/rahmanbazarov/Data/programming/BedRock/src/app/api/oauth/github/connect/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { generateStateToken, setStateCookie } from '@/lib/oauth/utils'\nimport { getGitHubAuthUrl } from '@/lib/oauth/github'\n\n// HEAD: check if OAuth is configured (used by frontend availability check)\nexport async function HEAD() {\n  if (!process.env.GITHUB_CLIENT_ID || !process.env.GITHUB_CLIENT_SECRET) {\n    return new NextResponse(null, { status: 503 })\n  }\n  return new NextResponse(null, { status: 200 })\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    if (!process.env.GITHUB_CLIENT_ID || !process.env.GITHUB_CLIENT_SECRET) {\n      return NextResponse.json({ error: 'GitHub OAuth not configured' }, { status: 503 })\n    }\n\n    const state = generateStateToken('github', 3)\n    await setStateCookie(state)\n    const url = getGitHubAuthUrl(state)\n\n    return NextResponse.redirect(url)\n  } catch (error) {\n    console.error('GitHub connect error:', error)\n    return NextResponse.redirect(\n      `${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/onboarding/oauth-success?provider=github&error=${encodeURIComponent('Failed to initiate GitHub OAuth')}`\n    )\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAGO,eAAe;IACpB,IAAI,CAAC,QAAQ,GAAG,CAAC,gBAAgB,IAAI,CAAC,QAAQ,GAAG,CAAC,oBAAoB,EAAE;QACtE,OAAO,IAAI,gJAAY,CAAC,MAAM;YAAE,QAAQ;QAAI;IAC9C;IACA,OAAO,IAAI,gJAAY,CAAC,MAAM;QAAE,QAAQ;IAAI;AAC9C;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,IAAI,CAAC,QAAQ,GAAG,CAAC,gBAAgB,IAAI,CAAC,QAAQ,GAAG,CAAC,oBAAoB,EAAE;YACtE,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA8B,GAAG;gBAAE,QAAQ;YAAI;QACnF;QAEA,MAAM,QAAQ,IAAA,oJAAkB,EAAC,UAAU;QAC3C,MAAM,IAAA,gJAAc,EAAC;QACrB,MAAM,MAAM,IAAA,mJAAgB,EAAC;QAE7B,OAAO,gJAAY,CAAC,QAAQ,CAAC;IAC/B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,QAAQ,CAC1B,GAAG,6DAAmC,wBAAwB,gDAAgD,EAAE,mBAAmB,oCAAoC;IAE3K;AACF"}}]
}