{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/rahmanbazarov/Data/programming/BedRock/src/lib/oauth/github.ts"],"sourcesContent":["import { Octokit } from '@octokit/rest'\nimport { getAppUrl } from './utils'\n\nexport interface GitHubProfileData {\n  login: string\n  name: string | null\n  avatarUrl: string\n  createdAt: string\n  accountAgeYears: number\n  publicRepos: number\n  followers: number\n  totalStars: number\n  topLanguages: string[]\n}\n\nexport function getGitHubAuthUrl(state: string): string {\n  const clientId = process.env.GITHUB_CLIENT_ID\n  if (!clientId) throw new Error('GITHUB_CLIENT_ID is not set')\n\n  const params = new URLSearchParams({\n    client_id: clientId,\n    scope: 'read:user',\n    state,\n    redirect_uri: `${getAppUrl()}/api/oauth/github/callback`,\n  })\n\n  return `https://github.com/login/oauth/authorize?${params.toString()}`\n}\n\nexport async function exchangeGitHubCode(code: string): Promise<string> {\n  const response = await fetch('https://github.com/login/oauth/access_token', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      Accept: 'application/json',\n    },\n    body: JSON.stringify({\n      client_id: process.env.GITHUB_CLIENT_ID,\n      client_secret: process.env.GITHUB_CLIENT_SECRET,\n      code,\n    }),\n  })\n\n  const data = await response.json()\n  if (data.error) {\n    throw new Error(`GitHub OAuth error: ${data.error_description || data.error}`)\n  }\n\n  return data.access_token\n}\n\nexport async function fetchGitHubProfile(token: string): Promise<GitHubProfileData> {\n  const octokit = new Octokit({ auth: token })\n\n  const { data: user } = await octokit.users.getAuthenticated()\n\n  const { data: repos } = await octokit.repos.listForAuthenticatedUser({\n    sort: 'pushed',\n    per_page: 100,\n  })\n\n  // Aggregate languages\n  const langCounts: Record<string, number> = {}\n  let totalStars = 0\n\n  for (const repo of repos) {\n    if (repo.language) {\n      langCounts[repo.language] = (langCounts[repo.language] || 0) + 1\n    }\n    totalStars += repo.stargazers_count ?? 0\n  }\n\n  const topLanguages = Object.entries(langCounts)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 5)\n    .map(([lang]) => lang)\n\n  const createdAt = user.created_at\n  const accountAgeYears = Math.floor(\n    (Date.now() - new Date(createdAt).getTime()) / (365.25 * 24 * 60 * 60 * 1000)\n  )\n\n  return {\n    login: user.login,\n    name: user.name,\n    avatarUrl: user.avatar_url,\n    createdAt,\n    accountAgeYears,\n    publicRepos: user.public_repos,\n    followers: user.followers,\n    totalStars,\n    topLanguages,\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;AAcO,SAAS,iBAAiB,KAAa;IAC5C,MAAM,WAAW,QAAQ,GAAG,CAAC,gBAAgB;IAC7C,IAAI,CAAC,UAAU,MAAM,IAAI,MAAM;IAE/B,MAAM,SAAS,IAAI,gBAAgB;QACjC,WAAW;QACX,OAAO;QACP;QACA,cAAc,GAAG,IAAA,2IAAS,IAAG,0BAA0B,CAAC;IAC1D;IAEA,OAAO,CAAC,yCAAyC,EAAE,OAAO,QAAQ,IAAI;AACxE;AAEO,eAAe,mBAAmB,IAAY;IACnD,MAAM,WAAW,MAAM,MAAM,+CAA+C;QAC1E,QAAQ;QACR,SAAS;YACP,gBAAgB;YAChB,QAAQ;QACV;QACA,MAAM,KAAK,SAAS,CAAC;YACnB,WAAW,QAAQ,GAAG,CAAC,gBAAgB;YACvC,eAAe,QAAQ,GAAG,CAAC,oBAAoB;YAC/C;QACF;IACF;IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;IAChC,IAAI,KAAK,KAAK,EAAE;QACd,MAAM,IAAI,MAAM,CAAC,oBAAoB,EAAE,KAAK,iBAAiB,IAAI,KAAK,KAAK,EAAE;IAC/E;IAEA,OAAO,KAAK,YAAY;AAC1B;AAEO,eAAe,mBAAmB,KAAa;IACpD,MAAM,UAAU,IAAI,sKAAO,CAAC;QAAE,MAAM;IAAM;IAE1C,MAAM,EAAE,MAAM,IAAI,EAAE,GAAG,MAAM,QAAQ,KAAK,CAAC,gBAAgB;IAE3D,MAAM,EAAE,MAAM,KAAK,EAAE,GAAG,MAAM,QAAQ,KAAK,CAAC,wBAAwB,CAAC;QACnE,MAAM;QACN,UAAU;IACZ;IAEA,sBAAsB;IACtB,MAAM,aAAqC,CAAC;IAC5C,IAAI,aAAa;IAEjB,KAAK,MAAM,QAAQ,MAAO;QACxB,IAAI,KAAK,QAAQ,EAAE;YACjB,UAAU,CAAC,KAAK,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,KAAK,QAAQ,CAAC,IAAI,CAAC,IAAI;QACjE;QACA,cAAc,KAAK,gBAAgB,IAAI;IACzC;IAEA,MAAM,eAAe,OAAO,OAAO,CAAC,YACjC,IAAI,CAAC,CAAC,GAAG,IAAM,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,EAAE,EAC1B,KAAK,CAAC,GAAG,GACT,GAAG,CAAC,CAAC,CAAC,KAAK,GAAK;IAEnB,MAAM,YAAY,KAAK,UAAU;IACjC,MAAM,kBAAkB,KAAK,KAAK,CAChC,CAAC,KAAK,GAAG,KAAK,IAAI,KAAK,WAAW,OAAO,EAAE,IAAI,CAAC,SAAS,KAAK,KAAK,KAAK,IAAI;IAG9E,OAAO;QACL,OAAO,KAAK,KAAK;QACjB,MAAM,KAAK,IAAI;QACf,WAAW,KAAK,UAAU;QAC1B;QACA;QACA,aAAa,KAAK,YAAY;QAC9B,WAAW,KAAK,SAAS;QACzB;QACA;IACF;AACF"}}]
}